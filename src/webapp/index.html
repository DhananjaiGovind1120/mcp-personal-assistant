<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Assistant (MCP)</title>
</head>
<body>
  <h1>AI Assistant</h1>
  <select id="toolSelect">
    <option value="add_task">Add Task</option>
    <option value="list_tasks">List Tasks</option>
    <option value="summarize_text">Summarize Text</option>
  </select>
  <br><br>
  <textarea id="inputBox" rows="4" cols="50" placeholder="Type your message..."></textarea>
  <br>
  <button onclick="sendToMCP()">Send</button>
  <pre id="responseBox"></pre>

  <script>
    async function sendToMCP() {
      const tool = document.getElementById("toolSelect").value;
      const input = document.getElementById("inputBox").value;
      const responseBox = document.getElementById("responseBox");
  
      const sessionId = "session-" + Date.now();
      responseBox.innerText = "‚è≥ Connecting...";
  
      const payload = {
        type: "callTool",
        tool_name: tool,
        arguments: {
          task: input,
          text: input
        }
      };
  
      console.log("Payload:", payload);
  
      // Step 1: Set up SSE first
      const eventSource = new EventSource(`/sse?session_id=${sessionId}`);
  
      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data?.type === "toolResult") {
          responseBox.innerText = `‚úÖ ${data.result}`;
          eventSource.close();
        }
      };
  
      eventSource.onerror = () => {
        responseBox.innerText = "‚ùå SSE connection error.";
        eventSource.close();
      };
  
      // Step 2: Send POST shortly after opening SSE stream
      // Wait for the connection to stabilize
      eventSource.onopen = () => {
        responseBox.innerText = "üì§ Sending tool call...";
        setTimeout(() => {
          fetch(`/messages/?session_id=${sessionId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          }).then((res) => {
            if (!res.ok) {
              responseBox.innerText = `‚ùå Error: ${res.status}`;
              eventSource.close();
            }
          }).catch((err) => {
            responseBox.innerText = `‚ùå Error: ${err}`;
            eventSource.close();
          });
        }, 200); // Wait 200ms after onopen
      };
    }
  </script>      
</body>
</html>
